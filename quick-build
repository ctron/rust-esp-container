#!/usr/bin/env bash

set -euxo pipefail

cargo +xtensa xbuild --target "${XARGO_TARGET:-xtensa-esp32-none-elf}" "$@"

if [ -x ./image.sh ]
then
     # If available, use script generated by esp_idf_build::esptool_write_script()
     . ./image.sh
else
     "${IDF_PATH}/components/esptool_py/esptool/esptool.py" \
          --chip esp32 \
          elf2image \
          -o build/esp-app.bin \
          target/xtensa-esp32-none-elf/release/esp-app
fi

echo "You can now flash 'build/esp-app.bin'"
